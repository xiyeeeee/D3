<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citizenship Over Time</title>
    <script src="http://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/colorbrewer.v1.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body id="indexb">
    <div class="content-wrapper">
        <header>
            <h1>Sarawak Tourism Analysis (2017-2021)</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="dataset.html">Dataset</a></li>
                    <li class="dropdown">
                        <a href="#">Visualizations</a>
                        <div class="dropdown-content">
                            <a href="yearly.html">Contribution to Yearly Total</a>
                            <a href="citizenship.html">Citizenship Over Time</a>
                            <a href="covid.html">COVID-19 Impact Analysis</a>
                        </div>
                    </li>
                    <li><a href="profile.html">Profile</a></li>
                </ul>
            </nav>            
        </header>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <h2>Citizenship Over Time</h2>

        <div class="button-container">
            <!-- Yearly Data Buttons -->
            <div class="yearly-buttons">
                <button data-year="2017" onclick="loadData(2017, 'Grand Total')">2017</button>
                <button data-year="2018" onclick="loadData(2018, 'Grand Total')">2018</button>
                <button data-year="2019" onclick="loadData(2019, 'Grand Total')">2019</button>
                <button data-year="2020" onclick="loadData(2020, 'Grand Total')">2020</button>
                <button data-year="2021" onclick="loadData(2021, 'Grand Total')">2021</button>
            </div>
            <!-- Monthly Data Buttons -->
            <div class="monthly-buttons">
                <button data-month="January" onclick="loadMonthData('January')">January</button>
                <button data-month="February" onclick="loadMonthData('February')">February</button>
                <button data-month="March" onclick="loadMonthData('March')">March</button>
                <button data-month="April" onclick="loadMonthData('April')">April</button>
                <button data-month="May" onclick="loadMonthData('May')">May</button>
                <button data-month="June" onclick="loadMonthData('June')">June</button>
                <button data-month="July" onclick="loadMonthData('July')">July</button>
                <button data-month="August" onclick="loadMonthData('August')">August</button>
                <button data-month="September" onclick="loadMonthData('September')">September</button>
                <button data-month="October" onclick="loadMonthData('October')">October</button>
                <button data-month="November" onclick="loadMonthData('November')">November</button>
                <button data-month="December" onclick="loadMonthData('December')">December</button>
            </div>            
            <!-- Zoom buttons -->
            <div class="zoom-buttons">
                <button onclick="zoom('in')">Zoom In</button>
                <button onclick="zoom('out')">Zoom Out</button>
            </div>
        </div>

        <div id="world-map"></div>
        <figcaption id="data-caption"></figcaption>        
    </div> <!-- end content-wrapper -->
<footer>
    <p>Â© 2023 Sarawak Tourism Analysis Project. All rights reserved.</p>
</footer>

<script>
    const width = 1200, height = 600;
    const svg = d3.select("#world-map").append("svg")
        .attr("width", width)
        .attr("height", height);
    const projection = d3.geoNaturalEarth1()
        .scale(width / 2 / Math.PI)
        .translate([width / 2, height / 2]);
    const path = d3.geoPath().projection(projection);

    const g = svg.append("g");

    let currentData; 
    let currentYear = 2017;
    let currentMonth = 'January'; 

    function updateCaption(year, month) {
        document.getElementById("data-caption").innerText = `Citizenship Over Time for Year ${year}, Month ${month}`;
    }

    function loadData(year, month = 'January') {
        currentYear = year;
        console.log("Loading year:", currentYear);  // Log which year is being loaded
        loadMonthData(month);
    }

    function loadMonthData(month) {
        d3.csv(`dataset/Sarawak_Visitor_Arrivals_${currentYear}.csv`)
        .then(data => {
            console.log("Data loaded for year " + currentYear + ":", data);
            currentData = data;
            currentMonth = month;

            renderMap(currentData, month);
            updateCaption(currentYear, month);
        })
        .catch(error => {
            console.error("Error loading the CSV for year " + currentYear + ":", error);
        });

        updateActiveButtons(currentYear, month);
    }


    function updateActiveButtons(year, month) {
        // Remove active class from all buttons first
        document.querySelectorAll('.yearly-buttons button, .monthly-buttons button').forEach(btn => {
            btn.classList.remove('active');
        });

        // Add active class to the currently clicked year and month
        document.querySelector(`.yearly-buttons button[data-year="${year}"]`).classList.add('active');
        document.querySelector(`.monthly-buttons button[data-month="${month}"]`).classList.add('active');
    }

    const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    function renderMap(data, month) {
        const maxVisitors = d3.max(data, d => +d[month]);
        console.log("Max visitors for", month, ":", maxVisitors);  // Log max visitors
        const colorScale = d3.scaleSequential(d3.interpolateBlues).domain([1, maxVisitors]);

        d3.json("world.json").then(world => {
            if (!world.features) {
                console.error("No features found in the GeoJSON. Check its structure.");
                return;
            }

            world.features.forEach(feature => {
                const country = feature.properties.name;
                const match = data.find(d => d.Citizenship === country);
                feature.properties.visitors = match ? +match[month] : 0; 
            });

            g.selectAll("path").remove();

            g.selectAll("path")
                .data(world.features)
                .enter().append("path")
                .attr("d", path)
                .attr("fill", d => d.properties.visitors > 0 ? colorScale(d.properties.visitors) : "grey")
                .attr("stroke", "#fff")
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(d.properties.name + "<br/>" + (d.properties.visitors || "No data"))
                        .style("left", (event.pageX) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });
        }).catch(error => console.error("GeoJSON Error:", error));
    }

    const zoomBehavior = d3.zoom()
        .scaleExtent([1, 5])
        .on("zoom", (event) => {
            g.attr('transform', event.transform);
        });

    svg.call(zoomBehavior);

    function zoom(action) {
        const currentZoom = svg.node().__zoom.k;
        if (action === 'in') {
            svg.transition().duration(500).call(zoomBehavior.scaleTo, currentZoom * 1.5);
        } else if (action === 'out') {
            svg.transition().duration(500).call(zoomBehavior.scaleTo, currentZoom / 1.5);
        }
    }

    window.onload = function() {
        loadData(2017, 'January');
    }
</script>


</body>
</html>
